<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <title>Visualização AR com QR Code</title>

    <!-- AR.js + A-Frame -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.3.2/aframe/build/aframe-ar.js"></script>

    <!-- Leitor de QR Code -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      #reader {
        position: absolute;
        top: 10px; left: 10px;
        width: 200px;
        z-index: 10;
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 8px rgba(0,0,0,0.2);
      }
    </style>
  </head>
  <body>
    <!-- Scanner de QR Code -->
    <div id="reader"></div>

    <!-- Cena AR -->
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      vr-mode-ui="enabled: false">
      
      <a-marker type="pattern" url="./markers/marcador.patt">
        <a-entity id="modelo" position="0 0 0" scale="0.4 0.4 0.4"></a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const apiBaseUrl = "http://localhost:4000";

      const html5QrCode = new Html5Qrcode("reader");

  function onScanSuccess(decodedText) {
    alert("QR Code lido: " + decodedText);
    const id = decodedText.trim();

    fetch(`${apiBaseUrl}/api/modelagem/${id}`)
    .then(res => res.json())
    .then(data => {
    if (data.modelagem && data.modelagem.arquivoModelagem) {
      const modeloUrl = `${apiBaseUrl}/modelos/${data.modelagem.arquivoModelagem}`;
      console.log("Carregando modelo:", modeloUrl);
      document.querySelector("#modelo").setAttribute("gltf-model", modeloUrl);
    } else {
      alert("Modelagem não encontrada!");
    }
  })
  .catch(err => console.error("Erro ao buscar modelo:", err));

  }

  html5QrCode
    .start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess
    )
    .catch((err) => {
      console.error("Erro ao iniciar leitor:", err);
      alert("Erro ao iniciar leitor: " + err);
    });
    </script>
  </body>
</html>
